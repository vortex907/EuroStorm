
calculate_GDP = {


	set_variable = { country_GDP = 0 }
	set_temp_variable = { temp_civ = 0 }
	set_temp_variable = { temp_mil = 0 }
	set_temp_variable = { temp_doc = num_of_naval_factories }

	set_variable = { country_GDP_M = 0 }
	set_variable = { country_GDP_B = 0 }
	
	set_temp_variable = { actual_core_manpower_k = 0 }
	set_temp_variable = { actual_core_manpower_nocore_k = 0 }
	clr_country_flag = gdp_menu
	every_owned_state = {
		limit = { is_core_of = PREV }
		add_to_temp_variable = { PREV.actual_core_manpower_k = state_population_k }
	}

		every_owned_state = {
			#limit = { is_full_controlled_by = PREV }
			add_to_temp_variable = { actual_manpower_k = state_population_k }
		}

		every_owned_state = {
			limit = {
				NOT = {
					is_core_of = PREV 
				} 
			}
			add_to_temp_variable = { PREV.actual_core_manpower_nocore_k = state_population_k }
		}

	




		every_country = {
			set_variable = {
				This.country_category_factor = 0
			}
			
			set_variable = {
				This.country_num_states = This.num_core_states
			}

		}	
		every_state = {
			limit = {
				is_core_of = PREV
			}
			set_variable = { state_category_factor = 1 }
			if = {
				limit = { 
					OR = { 
						has_state_category = megalopolis 
						has_state_category = twelve
					}
				}
				multiply_variable = { state_category_factor = 3 }
			}
			else_if = {
				limit = { 
					OR = {
						has_state_category = metropolis 
						has_state_category = eleven
						has_state_category = nine
					}
				}
				multiply_variable = { state_category_factor = 2 }
			}
			else_if = {
				limit = { 
					OR = {
						has_state_category = large_city 
						has_state_category = eight
						has_state_category = seven 
					}
				}
				multiply_variable = { state_category_factor = 1.5 }
			}
			else_if = {
				limit = { 
					OR = {
							has_state_category = city 
							has_state_category = major_port 
							has_state_category = six
					}
				}
				multiply_variable = { state_category_factor = 1.25 }
			}
			else_if = {
				limit = { 
					OR = {
						has_state_category = large_town 
						has_state_category = port 
						has_state_category = minor_port 
						has_state_category = five
						
					}
				}
				multiply_variable = { state_category_factor = 1 }
			}
			else_if = {
				limit = { 
					OR = { 
						has_state_category = town 
						has_state_category = four 
					}
				}
				multiply_variable = { state_category_factor = 0.75 }
			}
			else_if = {
				limit = {
					OR = {
						has_state_category = rural
						has_state_category = three
					}  
				}
				multiply_variable = { state_category_factor = 0.6 }
			}
			else_if = {
				limit = { 
					OR = {
						has_state_category = pastoral 
						has_state_category = two
					}
				}
				multiply_variable = { state_category_factor = 0.25 }
			}
			else = {
				multiply_variable = { state_category_factor = 0.1 }
			}
			OWNER = {
				add_to_variable = { This.country_category_factor = Prev.state_category_factor }
			}

		}
		every_country = {
			divide_variable = { This.country_category_factor = This.country_num_states }
			subtract_from_variable = { country_category_factor = 1 }
			divide_variable = { country_category_factor = 10 }
			set_variable = { country_category_factor_1 = 1 }
			add_to_variable = { country_category_factor_1 = country_category_factor }
		}	

		set_variable = { temp_8 = country_category_factor_1 }


		every_country = {
			set_variable = {
				This.country_average_inf = 0
			}
			set_variable = {
				This.country_num_states = This.num_owned_states
			}
		}	
		every_state = {
			set_variable = {
				state_inf = 0
			}
			add_to_variable = { state_inf = This.infrastructure_level }
			OWNER = {
				add_to_variable = { This.country_average_inf = Prev.state_inf }
			}
		}
		every_country = {
			divide_variable = { This.country_average_inf = This.country_num_states }
		}	


		
		every_country = {
			set_variable = {
				This.country_civ = 0
			}
		}
		every_state = {
			set_variable = {
				state_civ = 0
			}
			# Use non_damaged_building_level if damage calculation enabled
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_civ = non_damaged_building_level@industrial_complex }
			}
			else = {
				add_to_variable = { state_civ = industrial_complex_level }
			}
			# DLC bonus: Nuclear reactor boosts civilian GDP
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_dlc_buildings
						option = TWR_GDP_DLC_ENABLED
					}
					has_dlc = "Gotterdammerung"
					nuclear_reactor > 0
				}
				multiply_variable = { state_civ = 1.3 }
			}
			controller = {
				add_to_variable = { This.country_civ = Prev.state_civ }
			}
		}	
		every_country = {
			set_variable = {
				This.country_civ_own = 0
			}
		}
		every_state = {
			set_variable = {
				state_civ_own = 0
			}
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_civ_own = non_damaged_building_level@industrial_complex }
			}
			else = {
				add_to_variable = { state_civ_own = industrial_complex_level }
			}
			OWNER = {
				add_to_variable = { This.country_civ_own = Prev.state_civ_own }
			}
		}	
	
		every_country = {
			set_variable = {
				This.country_civ_core = 0
			}
		}
		every_state = {
			limit = {
				is_core_of = PREV
			}
			set_variable = {
				state_civ_core = 0
			}
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_civ_core = non_damaged_building_level@industrial_complex }
			}
			else = {
				add_to_variable = { state_civ_core = industrial_complex_level }
			}
			OWNER = {
				add_to_variable = { This.country_civ_core = Prev.state_civ_core }
			}
		}	
		set_variable = { country_civ_con = 0 }
		add_to_variable = { country_civ_con = country_civ }


		set_variable = { country_civ_ocp_temp = country_civ }
		set_variable = { country_civ_coreown_temp = country_civ_core }
		set_variable = { country_civ_noncore_temp = country_civ_own }
		set_variable = { country_civ_core_temp = country_civ_core }
		subtract_from_variable = { country_civ_ocp_temp = country_civ_own }
		subtract_from_variable = { country_civ_noncore_temp  = country_civ_core_temp }
		subtract_from_variable = { country_civ_con  = country_civ_noncore_temp }
		
		subtract_from_variable = { country_civ_ocp_temp = country_civ_noncore_temp }
		clamp_variable = { var = country_civ_ocp_temp min = 0}

		set_temp_variable = { temp_9 = country_civ_ocp_temp }
		
		subtract_from_variable = { country_civ_con = temp_9 }



		set_temp_variable = { temp_civ_con = country_civ_con }
		add_to_temp_variable = { temp_civ = temp_civ_con }
		add_to_variable = { country_GDP = temp_civ }

		
		set_variable = { temp_civ_all = num_of_civilian_factories }
		subtract_from_variable = { temp_civ_all = country_civ }
		clamp_variable = { var = temp_civ_all min = 0}

		set_temp_variable = { temp_2 = temp_civ_all }
		divide_temp_variable = { temp_2 = 1 }
		add_to_temp_variable = { temp_civ = temp_2 }

		#if = {
			#limit = { 
				#check_variable = { country_civ_ocp_temp_1 > 0 }
		#	}
			

		#}


		
		set_temp_variable = { temp_4 = country_civ_ocp_temp }
		divide_temp_variable = { temp_4 = 10 }

		set_temp_variable = { temp_6 = country_civ_noncore_temp }
		divide_temp_variable = { temp_6 = 5 }



		add_to_temp_variable = { temp_civ = temp_4 } 
		
		add_to_temp_variable = { temp_civ = temp_6 }





		every_country = {
			set_variable = {
				This.country_arms = 0
			}
		}	
		every_state = {
			set_variable = {
				state_arms = 0
			}
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_arms = non_damaged_building_level@arms_factory }
			}
			else = {
				add_to_variable = { state_arms = arms_factory_level }
			}
			# DLC bonus: Radar boosts military GDP
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_dlc_buildings
						option = TWR_GDP_DLC_ENABLED
					}
					radar_station > 0
				}
				multiply_variable = { state_arms = 1.2 }
			}
			controller = {
				add_to_variable = { This.country_arms = Prev.state_arms }
			}
		}


		every_country = {
			set_variable = {
				This.country_arms_own = 0
			}
		}
		every_state = {
			set_variable = {
				state_arms_own = 0
			}
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_arms_own = non_damaged_building_level@arms_factory }
			}
			else = {
				add_to_variable = { state_arms_own = arms_factory_level }
			}
			OWNER = {
				add_to_variable = { This.country_arms_own = Prev.state_arms_own }
			}
		}	
	
		every_country = {
			set_variable = {
				This.country_arms_core = 0
			}
		}
		every_state = {
			limit = {
				is_core_of = PREV
			}
			set_variable = {
				state_arms_core = 0
			}
			if = {
				limit = {
					has_game_rule = {
						rule = TWR_GDP_damage_calculation
						option = TWR_GDP_DAMAGE_ENABLED
					}
				}
				add_to_variable = { state_arms_core = non_damaged_building_level@arms_factory }
			}
			else = {
				add_to_variable = { state_arms_core = arms_factory_level }
			}
			OWNER = {
				add_to_variable = { This.country_arms_core = Prev.state_arms_core }
			}
		}	
	
	
		set_variable = { country_arms_con = 0 }
		add_to_variable = { country_arms_con = country_arms }

	
		set_variable = { country_arms_ocp_temp = country_arms }
		set_variable = { country_arms_coreown_temp = country_arms_core }
		set_variable = { country_arms_noncore_temp = country_arms_own }
		set_variable = { country_arms_core_temp = country_arms_core }
	
		subtract_from_variable = { country_arms_ocp_temp = country_arms_coreown_temp }

		subtract_from_variable = { country_arms_noncore_temp  = country_arms_core_temp }

		subtract_from_variable = { country_arms_con = country_arms_noncore_temp }

		subtract_from_variable = { country_arms_ocp_temp = country_arms_noncore_temp }

		clamp_variable = { var = country_arms_ocp_temp min = 0}
		set_temp_variable = { temp_10 = country_civ_ocp_temp }
		
		subtract_from_variable = { country_arms_con = temp_10 }



		set_temp_variable = { temp_arms_con = country_arms_con }
		add_to_temp_variable = { temp_mil = temp_arms_con }

		set_temp_variable = { temp_5 = country_arms_ocp_temp }
		divide_temp_variable = { temp_5 = 20 }

		set_temp_variable = { temp_7 = country_arms_noncore_temp }
		divide_temp_variable = { temp_7 = 8 }


		add_to_temp_variable = { temp_mil = temp_5 } #

		add_to_temp_variable = { temp_mil = temp_7 } #
		#is_full_controlled_by




		

		set_variable = { overlord_factor = 1 }
		set_variable = { overlord_factor_2 = modifier@cic_to_overlord_factor }
		multiply_variable = { overlord_factor_2 = 0.99 }
		subtract_from_variable = { overlord_factor = overlord_factor_2 }
		multiply_variable = { temp_civ = overlord_factor }
	
		set_variable = { m_overlord_factor = 1 }
		set_variable = { m_overlord_factor_2 = modifier@mic_to_overlord_factor }
		multiply_variable = { m_overlord_factor_2 = 0.99 }
		subtract_from_variable = { m_overlord_factor = m_overlord_factor_2 }
		multiply_variable = { temp_mil = m_overlord_factor }

		# Colonial/Subject penalty - colonies and puppets have reduced GDP
		if = {
			limit = {
				is_subject = yes
			}
			# Integrated puppets get less penalty
			if = {
				limit = {
					OR = {
						is_subject_of_type = dominion
						is_subject_of_type = satellite
					}
				}
				multiply_temp_variable = { temp_civ = 0.7 }
				multiply_temp_variable = { temp_mil = 0.7 }
				multiply_temp_variable = { temp_doc = 0.7 }
			}
			# Colonial subjects get heavy penalty
			else_if = {
				limit = {
					OR = {
						is_subject_of_type = colony
						is_subject_of_type = colonial_government
						is_subject_of_type = crown_colony
						is_subject_of_type = puppet
						is_subject_of_type = integrated_puppet
					}
				}
				multiply_temp_variable = { temp_civ = 0.4 }
				multiply_temp_variable = { temp_mil = 0.4 }
				multiply_temp_variable = { temp_doc = 0.4 }
			}
			# Other subjects
			else = {
				multiply_temp_variable = { temp_civ = 0.5 }
				multiply_temp_variable = { temp_mil = 0.5 }
				multiply_temp_variable = { temp_doc = 0.5 }
			}
		}

		# Policy modifiers (if formula enabled)
		if = {
			limit = {
				has_game_rule = { rule = TWR_GDP_formula option = TWR_GDP_FORMULA_ENABLED }
			}
			# Trade law modifiers
			if = {
				limit = { has_idea = free_trade }
				multiply_temp_variable = { temp_civ = 1 }
				multiply_temp_variable = { temp_mil = 1 }
				multiply_temp_variable = { temp_doc = 1 }
			}
			else_if = {
				limit = { has_idea = export_focus }
				multiply_temp_variable = { temp_civ = 0.97 }
				multiply_temp_variable = { temp_mil = 0.97 }
				multiply_temp_variable = { temp_doc = 0.97 }
			}
			else_if = {
				limit = { has_idea = limited_exports }
				multiply_temp_variable = { temp_civ = 0.95 }
				multiply_temp_variable = { temp_mil = 0.95 }
				multiply_temp_variable = { temp_doc = 0.95 }
			}
			else_if = {
				limit = { has_idea = closed_economy }
				multiply_temp_variable = { temp_civ = 0.9 }
				multiply_temp_variable = { temp_mil = 0.9 }
				multiply_temp_variable = { temp_doc = 0.9 }
			}
			else_if = {
				limit = { has_idea = uncontrolled_exports }
				multiply_temp_variable = { temp_civ = 0.95 }
				multiply_temp_variable = { temp_mil = 0.95 }
				multiply_temp_variable = { temp_doc = 0.95 }
			}
		
			# Economy law modifiers
			if = {
				limit = { has_idea = tot_economic_mobilisation }
				multiply_temp_variable = { temp_civ = 0.9 }
				multiply_temp_variable = { temp_mil = 0.99 }
				multiply_temp_variable = { temp_doc = 0.98 }
			}
			else_if = {
				limit = { has_idea = isolation }
				multiply_temp_variable = { temp_civ = 0.95 }
				multiply_temp_variable = { temp_mil = 0.95 }
				multiply_temp_variable = { temp_doc = 0.95 }
			}
			else_if = {
				limit = { has_idea = war_economy }
				multiply_temp_variable = { temp_civ = 0.93 }
				multiply_temp_variable = { temp_mil = 0.98 }
				multiply_temp_variable = { temp_doc = 0.96 }
			}
			else_if = {
				limit = { has_idea = partial_economic_mobilisation }
				multiply_temp_variable = { temp_civ = 0.96 }
				multiply_temp_variable = { temp_mil = 0.93 }
				multiply_temp_variable = { temp_doc = 0.93 }
			}
			else_if = {
				limit = { has_idea = undisturbed_isolation }
				multiply_temp_variable = { temp_civ = 1 }
				multiply_temp_variable = { temp_mil = 0.9 }
				multiply_temp_variable = { temp_doc = 0.9 }
			}
			else_if = {
				limit = { has_idea = low_economic_mobilisation }
				multiply_temp_variable = { temp_civ = 0.98 }
				multiply_temp_variable = { temp_mil = 0.92 }
				multiply_temp_variable = { temp_doc = 0.92 }
			}
			else_if = {
				limit = { has_idea = civilian_economy }
				multiply_temp_variable = { temp_civ = 1 }
				multiply_temp_variable = { temp_mil = 0.9 }
				multiply_temp_variable = { temp_doc = 0.9 }
			}
			
			# Conscription law modifiers
			if = {
				limit = { has_idea = service_by_requirement }
				multiply_temp_variable = { temp_civ = 0.98 }
				multiply_temp_variable = { temp_mil = 0.9 }
				multiply_temp_variable = { temp_doc = 0.9 }
			}
			else_if = {
				limit = { has_idea = all_adults_serve }
				multiply_temp_variable = { temp_civ = 0.95 }
				multiply_temp_variable = { temp_mil = 0.85 }
				multiply_temp_variable = { temp_doc = 0.85 }
			}
			else_if = {
				limit = { has_idea = scraping_the_barrel }
				multiply_temp_variable = { temp_civ = 0.7 }
				multiply_temp_variable = { temp_mil = 0.5 }
				multiply_temp_variable = { temp_doc = 0.5 }
			}
			else_if = {
				limit = {
					has_idea = ETH_chitet_law
					original_tag = ETH
				}
				multiply_temp_variable = { temp_civ = 0.9 }
				multiply_temp_variable = { temp_mil = 0.9 }
				multiply_temp_variable = { temp_doc = 0.9 }
			}
			else_if = {
				limit = {
					has_idea = TUR_debt_council
					original_tag = TUR
				}
				multiply_temp_variable = { temp_civ = 0.95 }
				multiply_temp_variable = { temp_mil = 0.95 }
				multiply_temp_variable = { temp_doc = 0.95 }
			}
		} # End of formula enabled check
		


		#set_variable = { population_noncore_modifier = 1 }
		#set_variable = { population_noncore_state = actual_manpower_k }
		#divide_variable = { population_noncore_state = 5000 }
		#divide_variable = { population_noncore_state = 5000 }
	
		
		#add_to_variable = { population_noncore_modifier = population_noncore_state }
		#multiply_variable = { country_GDP = population_noncore_modifier }

	
		#set_temp_variable = { temp_civ_modifier = 1 }


		#set_temp_variable = { temp_mil_all = num_of_military_factories }
		#subtract_from_variable = { temp_mil_all = country_arms }
		#set_temp_variable = { temp_mil_modifier = 1 }
		#set_temp_variable = { temp_off = num_of_offices }

		#set_temp_variable = { temp_doc_modifier = 1 }
		
		set_temp_variable = { temp_0 = temp_mil }
		multiply_temp_variable = { temp_0 = 3 }
		divide_temp_variable = { temp_0 = 2 }


		set_temp_variable = { temp_1 = temp_doc }
		multiply_temp_variable = { temp_1 = 3 }
		divide_temp_variable = { temp_1 = 2 }

		add_to_variable = { country_GDP = temp_0 }
		add_to_variable = { country_GDP = temp_1 }


		#set_temp_variable = { temp_3 = temp_mil_all }
		#divide_temp_variable = { temp_3 = 20 }

	
		




	#set_temp_variable = { temp_adjust = temp_civ }
	#multiply_temp_variable = { temp_adjust = 1000 }
	#subtract_from_temp_variable = { temp_adjust = actual_core_manpower_k }
	


	set_variable = { population_modifier = 1 }
	set_variable = { population_modifier_civ = 1 }
	set_variable = { population_core_state = actual_core_manpower_k }
	set_variable = { population_core_state_1 = actual_core_manpower_k }

	set_variable = { population_modifier_1 = -1 }
	set_variable = { temp_nocore =  actual_core_manpower_nocore_k }
	divide_variable = { temp_nocore = 10 } # Non-core population contributes much less
	add_to_variable = { population_core_state = temp_nocore }

	divide_variable = { population_core_state = 3500 } #3.5M



	add_to_variable = { population_modifier_1 = population_core_state }

	if = { 
		limit = {
			check_variable = { population_core_state > 0.999 }
		}

		divide_variable = { population_modifier_1 = 500 }

	}

	add_to_variable = { population_modifier = population_modifier_1 }
	divide_variable = { population_core_state_1 = 3500 }
	divide_variable = { population_core_state_1 = 100 }
	add_to_variable = { population_modifier_civ = population_core_state_1 }

	clamp_variable = { var = population_modifier min = 0  max = 1.25 }

	multiply_variable = { country_GDP = population_modifier }

	# Additional penalty for countries with very low core population but high non-core
	# This prevents colonial territories from having inflated GDP
	if = {
		limit = {
			check_variable = { actual_core_manpower_k < 1000 }
			check_variable = { actual_core_manpower_nocore_k > 5000 }
		}
		set_variable = { colonial_ratio = actual_core_manpower_nocore_k }
		divide_variable = { colonial_ratio = actual_core_manpower_k }
		clamp_variable = { var = colonial_ratio min = 1 max = 50 }
		divide_variable = { colonial_ratio = 10 }
		set_variable = { colonial_penalty = 1 }
		subtract_from_variable = { colonial_penalty = colonial_ratio }
		clamp_variable = { var = colonial_penalty min = 0.1 max = 1 }
		multiply_variable = { country_GDP = colonial_penalty }
	}

	clamp_variable = { var = population_modifier_civ min = 0  max = 5 }
	multiply_temp_variable = { temp_civ = population_modifier_civ }

	
	#set_variable = { saturation_value = 1.5 }
	#set_variable = { napier_1 = 87 }
	#set_variable = { napier = napier_1^2 }
	#set_variable = { n0 = 1 }
	#divide_variable = { napier = 32 }


	








	#multiply_temp_variable = { temp_civ = 3 }

	#multiply_temp_variable = { temp_doc = 3 }
	#multiply_temp_variable = { temp_mil = 3 }




		#Why does Malaysia have so many factories, and so many resources?
		#if = {
			#limit = { 
  	  	   # original_tag = MAL
			#is_ai = yes
  	 		#} 
				#multiply_temp_variable = { temp_civ = 0.3 }
				#multiply_temp_variable = { temp_mil = 0.5 }
				#multiply_variable= { temp_doc = 0.5 }
		#}
		#Temporary...
		#if = {
			#limit = { 
  	  	  #  original_tag = TRK
		#	is_ai = yes
  	 	#	} 
			  # multiply_variable = { country_GDP = 0.1 }	
		#}

		#if = {
			#limit = { 
  	  	    #original_tag = KYR
			#is_ai = yes
  	 		#} 

			   #multiply_variable = { country_GDP = 0.1 }	
		#}



		#if = { 
   		 #limit = { 
  	      #has_idea = GEA_colonial_question
  	 	# } 
			#multiply_temp_variable = { temp_civ = 0.9 }
			#multiply_temp_variable = { temp_mil = 0.9 }
			#multiply_variable= { temp_doc = 0.9 }
		#}


		#if = {
			#limit = {
			#check_variable = { actual_manpower_k < 5000 }

			#}
			#multiply_temp_variable = { temp_civ = 1 }
			#multiply_temp_variable = { temp_mil = 1 }
		#}




		#divide_temp_variable = { temp_adjust = 1000 }
		#clamp_temp_variable = { var = temp_civ min = 0 }
	






	













	#set_variable = { tstvar = actual_core_manpower_k }

	set_variable = { country_average_inf_1 = 1 }
	#set_variable = { actual_infra_manpower_k_1 = 1 }
	#set_variable = { actual_infra_manpower_k = actual_core_manpower_k }
	#divide_variable = { actual_infra_manpower_k = 9900000 }
	#add_to_variable = { actual_infra_manpower_k_1 = actual_infra_manpower_k }
	multiply_variable = { country_average_inf = 0.1 }
	add_to_variable = { country_average_inf_1 = country_average_inf }
	multiply_variable = { country_average_inf_1  = population_modifier }
	multiply_variable = { country_GDP = country_average_inf_1 }

	#add_to_variable = { country_GDP_per_capita = 0 }

	multiply_variable = { temp_8 = population_modifier }
	multiply_variable = { country_GDP = temp_8 }

	multiply_temp_variable = { temp_civ = 3 }








	

	#if = {
	#	limit = {
	#		has_idea = low_economic_mobilisation
	#	}
	#	multiply_temp_variable = { temp_civ  = 0.99 }
	#	multiply_temp_variable = { temp_mil = 0.9 }
	#}



	#set_variable = { temp_adjust_check = temp_civ }



		set_variable = { temp_civ_resource = 1 }
		set_variable = { temp_civ_resource_1 = temp_civ }
		multiply_variable = { temp_civ_resource_1 = 0.5 }
		add_to_variable = { temp_civ_resource = temp_civ_resource_1 }
	
		# Resource GDP - Produced (if enabled)
		if = {
			limit = {
				OR = {
					has_game_rule = { rule = TWR_GDP_resources option = TWR_GDP_RESOURCES_BOTH }
					has_game_rule = { rule = TWR_GDP_resources option = TWR_GDP_RESOURCES_PRODUCED }
				}
			}
			set_temp_variable = { math_sqrt_number = resource_produced@oil }
			divide_temp_variable = { math_sqrt_number = 2000 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
		
			set_temp_variable = { math_sqrt_number = resource_produced@aluminium }
			divide_temp_variable = { math_sqrt_number = 2000 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
		
			set_temp_variable = { math_sqrt_number = resource_produced@rubber }
			divide_temp_variable = { math_sqrt_number = 3500 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
		
			set_temp_variable = { math_sqrt_number = resource_produced@tungsten }
			divide_temp_variable = { math_sqrt_number = 2500 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
		
			set_temp_variable = { math_sqrt_number = resource_produced@steel }
			divide_temp_variable = { math_sqrt_number = 2000 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
			
			set_temp_variable = { math_sqrt_number = resource_produced@chromium }
			divide_temp_variable = { math_sqrt_number = 3000 }
			math_square_root = yes
			multiply_temp_variable = { math_sqrt_output = temp_civ_resource }
			add_to_variable = { country_GDP = math_sqrt_output }
		}

		# Resource GDP - Exported (if enabled)
		if = {
			limit = {
				OR = {
					has_game_rule = { rule = TWR_GDP_resources option = TWR_GDP_RESOURCES_BOTH }
					has_game_rule = { rule = TWR_GDP_resources option = TWR_GDP_RESOURCES_EXPORTED }
				}
			}
			set_temp_variable = { math_sqrt_number = resource_exported@oil }
			divide_temp_variable = { math_sqrt_number = 50 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }

			set_temp_variable = { math_sqrt_number = resource_exported@aluminium }
			divide_temp_variable = { math_sqrt_number = 50 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }

			set_temp_variable = { math_sqrt_number = resource_exported@rubber }
			divide_temp_variable = { math_sqrt_number = 100 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }

			set_temp_variable = { math_sqrt_number = resource_exported@tungsten }
			divide_temp_variable = { math_sqrt_number = 50 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }

			set_temp_variable = { math_sqrt_number = resource_exported@steel }
			divide_temp_variable = { math_sqrt_number = 50 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }

			set_temp_variable = { math_sqrt_number = resource_exported@chromium }
			divide_temp_variable = { math_sqrt_number = 50 }
			math_square_root = yes
			add_to_variable = { country_GDP = math_sqrt_output }
		}

		#set_temp_variable = { math_sqrt_number = resource_exported@coal }
		#divide_temp_variable = { math_sqrt_number = 200 }
		#math_square_root = yes

		#add_to_variable = { country_GDP = math_sqrt_output }

		#set_temp_variable = { math_sqrt_number = resource_exported@iron }
		#divide_temp_variable = { math_sqrt_number = 100 }
		#math_square_root = yes

		#add_to_variable = { country_GDP = math_sqrt_output }

		#set_temp_variable = { math_sqrt_number = resource_exported@bauxite }
		#divide_temp_variable = { math_sqrt_number = 100 }
		#math_square_root = yes

		#add_to_variable = { country_GDP = math_sqrt_output }





		clamp_temp_variable = { var = temp_civ min = 1 }
		#add_to_variable = { country_GDP = 0.01 }

	
		




	set_variable = { factory_output = 1 }
	set_variable = { factory_output_2 = modifier@industrial_capacity_factory }
	multiply_variable = { factory_output_2 = 0.2 }
	add_to_variable = { factory_output = factory_output_2 }
	clamp_variable = { var = factory_output min = 0.5 max = 1.5 }
	multiply_variable = { country_GDP = factory_output }




	#set_variable = { monthly_population = 1 }
	#set_variable = { monthly_2_population = modifier@monthly_population }

	#add_to_variable = { monthly_population = monthly_2_population }
	#clamp_variable = { var = monthly_population min = 0.5 max = 1.5 }
	#multiply_variable = { country_GDP = monthly_population }





	

	multiply_variable = { country_GDP = 0.107 }
	
	set_variable = { percentage_of_GDP = country_GDP }
	multiply_variable = { percentage_of_GDP = 100 }
	divide_variable = { percentage_of_GDP = global.GDP_total }
	clamp_variable = { var = percentage_of_GDP min = 0 }
	clamp_variable = { var = country_GDP min = 0 }


	set_variable = { country_GDP_per_capita = country_GDP }
	multiply_variable = { country_GDP_per_capita = 1000 }
	divide_variable = { country_GDP_per_capita = actual_core_manpower_k }
	multiply_variable = { country_GDP_per_capita = 1000 }
	clamp_variable = { var = country_GDP_per_capita min = 0 }


	

	if = {
		limit = {
			all_country = {
				is_in_array = { global.GDP_list_array = THIS }
			}
		}
		update_position = yes
	}
	#set_temp_variable = { country_GDP_a = country_GDP }
	#set_variable = { country_GDP_b = country_GDP }
	add_to_variable = { country_GDP_B = country_GDP }
	add_to_variable = { country_GDP_M = country_GDP }
	add_to_variable = { country_GDP_T = country_GDP }
	multiply_variable = { country_GDP_M = 1000 }
	multiply_variable = { country_GDP_T = 0.001 }



}





update_position = {
	clear_array = global.top_ten_GDP_array
	clear_variable = global.GDP_total
	clear_variable = global.GDP_per_capita_total
	
	set_temp_variable = { position = 0 }
	set_variable = { sort_var = 1 }
	set_variable = { last_sort_var = 0 }
	create_GDP_sorted_array = yes

	for_each_scope_loop = {
		array = global.GDP_list_array

		add_to_temp_variable = { position = 1 }
		set_variable = { THIS.GDP_position = position }

		if = {
			limit = {
				check_variable = { THIS.GDP_position < 11 }
			}
			add_to_array = { global.top_ten_GDP_array = THIS }
		}
		add_to_variable = { global.GDP_total = country_GDP }
		add_to_variable = { global.GDP_per_capita_total = country_GDP_per_capita }
	}

	set_variable = { global.average_GDP = global.GDP_total }
	divide_variable = { global.average_GDP = global.GDP_list_array^num }
	set_variable = { global.average_GDP_per_capita = global.GDP_per_capita_total }
	divide_variable = { global.average_GDP_per_capita = global.GDP_list_array^num }

	force_update_map_mode = { mapmode = TWR_GDP_map_mode }
	force_update_map_mode = { mapmode = TWR_GDP_per_capita_map_mode }
}

GDP_growth_calculation = { 
	
	set_variable = { GDP_growth_value = country_GDP }
	
	multiply_variable = { GDP_growth_value = 100 }
	
	divide_variable = { GDP_growth_value = gdp_value_last }
	if = {
	   limit = {
		   OR = { 
			   check_variable = {
				   var = GDP_growth_value
				   value = 100
			   }
			   check_variable = {
				   var = GDP_growth_value
				   value = 0
			   }
		   }
	   
	   }
		subtract_from_variable = { GDP_growth_value = 100 }
	}
	if = {
		limit = {
			check_variable = { GDP_growth_value = -0.001 }
		}
		multiply_variable = { GDP_growth_value = 0 }
	}
	multiply_variable = { GDP_growth_value = 1 }
	
	set_variable = { gdp_value_last = country_GDP }

}


# Calculate Regional GDP
calculate_region_GDP = {
	# Clear existing arrays
	clear_array = global.GDP_region_array
	
	# Initialize region GDP values
	set_variable = { global.GDP_europe = 0 }
	set_variable = { global.GDP_asia = 0 }
	set_variable = { global.GDP_north_america = 0 }
	set_variable = { global.GDP_south_america = 0 }
	set_variable = { global.GDP_africa = 0 }
	set_variable = { global.GDP_oceania = 0 }
	set_variable = { global.GDP_middle_east = 0 }
	
	# Calculate GDP for each region based on country capitals using continent
	every_country = {
		limit = {
			exists = yes
			is_in_array = { global.GDP_list_array = THIS }
		}
		# Asia
		if = {
			limit = {
				capital_scope = { is_on_continent = asia }
			}
			add_to_variable = { global.GDP_asia = country_GDP }
		}
		# North America
		else_if = {
			limit = {
				capital_scope = { is_on_continent = north_america }
			}
			add_to_variable = { global.GDP_north_america = country_GDP }
		}
		# South America
		else_if = {
			limit = {
				capital_scope = { is_on_continent = south_america }
			}
			add_to_variable = { global.GDP_south_america = country_GDP }
		}
		# Africa
		else_if = {
			limit = {
				capital_scope = { is_on_continent = africa }
			}
			add_to_variable = { global.GDP_africa = country_GDP }
		}
		# Oceania
		else_if = {
			limit = {
				capital_scope = { is_on_continent = australia }
			}
			add_to_variable = { global.GDP_oceania = country_GDP }
		}
		# Middle East
		else_if = {
			limit = {
				capital_scope = { is_on_continent = middle_east }
			}
			add_to_variable = { global.GDP_middle_east = country_GDP }
		}
		# Europe (default)
		else_if = {
			limit = {
				capital_scope = { is_on_continent = europe }
			}
			add_to_variable = { global.GDP_europe = country_GDP }
		}
		# Fallback
		else = {
			add_to_variable = { global.GDP_europe = country_GDP }
		}
	}
	
	# Calculate percentages
	set_variable = { global.GDP_europe_pct = global.GDP_europe }
	multiply_variable = { global.GDP_europe_pct = 100 }
	divide_variable = { global.GDP_europe_pct = global.GDP_total }
	
	set_variable = { global.GDP_asia_pct = global.GDP_asia }
	multiply_variable = { global.GDP_asia_pct = 100 }
	divide_variable = { global.GDP_asia_pct = global.GDP_total }
	
	set_variable = { global.GDP_north_america_pct = global.GDP_north_america }
	multiply_variable = { global.GDP_north_america_pct = 100 }
	divide_variable = { global.GDP_north_america_pct = global.GDP_total }
	
	set_variable = { global.GDP_south_america_pct = global.GDP_south_america }
	multiply_variable = { global.GDP_south_america_pct = 100 }
	divide_variable = { global.GDP_south_america_pct = global.GDP_total }
	
	set_variable = { global.GDP_africa_pct = global.GDP_africa }
	multiply_variable = { global.GDP_africa_pct = 100 }
	divide_variable = { global.GDP_africa_pct = global.GDP_total }
	
	set_variable = { global.GDP_oceania_pct = global.GDP_oceania }
	multiply_variable = { global.GDP_oceania_pct = 100 }
	divide_variable = { global.GDP_oceania_pct = global.GDP_total }
	
	set_variable = { global.GDP_middle_east_pct = global.GDP_middle_east }
	multiply_variable = { global.GDP_middle_east_pct = 100 }
	divide_variable = { global.GDP_middle_east_pct = global.GDP_total }
	
	# Create sorted region array (region_id: 1=Europe, 2=Asia, 3=NA, 4=SA, 5=Africa, 6=Oceania, 7=ME)
	clear_array = global.GDP_region_array
	clear_array = global.GDP_region_values
	
	# Store region GDP values with IDs
	set_variable = { global.GDP_region_values^0 = global.GDP_europe }
	set_variable = { global.region_id^0 = 1 }
	set_variable = { global.GDP_region_values^1 = global.GDP_asia }
	set_variable = { global.region_id^1 = 2 }
	set_variable = { global.GDP_region_values^2 = global.GDP_north_america }
	set_variable = { global.region_id^2 = 3 }
	set_variable = { global.GDP_region_values^3 = global.GDP_south_america }
	set_variable = { global.region_id^3 = 4 }
	set_variable = { global.GDP_region_values^4 = global.GDP_africa }
	set_variable = { global.region_id^4 = 5 }
	set_variable = { global.GDP_region_values^5 = global.GDP_oceania }
	set_variable = { global.region_id^5 = 6 }
	set_variable = { global.GDP_region_values^6 = global.GDP_middle_east }
	set_variable = { global.region_id^6 = 7 }
	
	# Sort regions by GDP (descending) - selection sort
	set_temp_variable = { num_regions = 7 }
	set_temp_variable = { i = 0 }
	while_loop_effect = {
		limit = { check_variable = { i < 6 } }
		
		set_temp_variable = { max_idx = i }
		set_temp_variable = { max_val = global.GDP_region_values^i }
		set_temp_variable = { j = i }
		add_to_temp_variable = { j = 1 }
		
		while_loop_effect = {
			limit = { check_variable = { j < 7 } }
			
			if = {
				limit = { check_variable = { global.GDP_region_values^j > max_val } }
				set_temp_variable = { max_idx = j }
				set_temp_variable = { max_val = global.GDP_region_values^j }
			}
			add_to_temp_variable = { j = 1 }
		}
		
		# Swap if needed
		if = {
			limit = { check_variable = { max_idx > i } }
			set_temp_variable = { temp_val = global.GDP_region_values^i }
			set_temp_variable = { temp_id = global.region_id^i }
			set_variable = { global.GDP_region_values^i = global.GDP_region_values^max_idx }
			set_variable = { global.region_id^i = global.region_id^max_idx }
			set_variable = { global.GDP_region_values^max_idx = temp_val }
			set_variable = { global.region_id^max_idx = temp_id }
		}
		
		add_to_temp_variable = { i = 1 }
	}
	
	# Copy sorted IDs to region array
	add_to_array = { global.GDP_region_array = global.region_id^0 }
	add_to_array = { global.GDP_region_array = global.region_id^1 }
	add_to_array = { global.GDP_region_array = global.region_id^2 }
	add_to_array = { global.GDP_region_array = global.region_id^3 }
	add_to_array = { global.GDP_region_array = global.region_id^4 }
	add_to_array = { global.GDP_region_array = global.region_id^5 }
	add_to_array = { global.GDP_region_array = global.region_id^6 }
}

# Calculate Faction GDP
calculate_faction_GDP = {
	clear_array = global.GDP_faction_array
	clear_array = global.GDP_faction_temp
	
	# Find all faction leaders and calculate their faction GDP
	every_country = {
		limit = {
			exists = yes
			is_faction_leader = yes
		}
		
		# Initialize faction GDP
		set_variable = { THIS.faction_GDP_total = 0 }
		
		# Add leader's GDP
		add_to_variable = { THIS.faction_GDP_total = country_GDP }
		
		# Add all faction members' GDP
		every_country = {
			limit = {
				is_in_faction_with = PREV
				NOT = { tag = PREV }
			}
			PREV = {
				add_to_variable = { faction_GDP_total = PREV.country_GDP }
			}
		}
		
		# Calculate percentage
		set_variable = { THIS.faction_GDP_pct = THIS.faction_GDP_total }
		multiply_variable = { THIS.faction_GDP_pct = 100 }
		divide_variable = { THIS.faction_GDP_pct = global.GDP_total }
		
		# Add to temp array
		add_to_array = { global.GDP_faction_temp = THIS }
	}
	
	# Add non-aligned countries total
	set_variable = { global.GDP_non_aligned = 0 }
	every_country = {
		limit = {
			exists = yes
			is_in_faction = no
			is_in_array = { global.GDP_list_array = THIS }
		}
		add_to_variable = { global.GDP_non_aligned = country_GDP }
	}
	
	set_variable = { global.GDP_non_aligned_pct = global.GDP_non_aligned }
	multiply_variable = { global.GDP_non_aligned_pct = 100 }
	divide_variable = { global.GDP_non_aligned_pct = global.GDP_total }
	
	# Sort by GDP descending
	while_loop_effect = {
		limit = { check_variable = { global.GDP_faction_temp^num > 0 } }
		
		# Find max GDP value
		set_variable = { global.faction_best_gdp = 0 }
		for_each_scope_loop = {
			array = global.GDP_faction_temp
			if = {
				limit = { check_variable = { faction_GDP_total > global.faction_best_gdp } }
				set_variable = { global.faction_best_gdp = faction_GDP_total }
			}
		}
		
		# Add the faction with best GDP to sorted array
		for_each_scope_loop = {
			array = global.GDP_faction_temp
			if = {
				limit = { 
					check_variable = { faction_GDP_total = global.faction_best_gdp }
					NOT = { is_in_array = { global.GDP_faction_array = THIS } }
				}
				add_to_array = { global.GDP_faction_array = THIS }
				remove_from_array = { global.GDP_faction_temp = THIS }
			}
		}
	}
}
